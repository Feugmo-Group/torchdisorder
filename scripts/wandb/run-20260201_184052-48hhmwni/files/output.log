
======================================================================
  TARGET DATA CONFIGURATION
======================================================================
  ⚙ Auto-generated r_bins: 1000 bins, r_max=20.0 Å
  Note: S_of_Q.csv has no uncertainty column. Using default 0.05
  ✓ Loaded S(Q): 7725 bins from S_of_Q.csv

  Data Files:
    F(Q)/S(Q) path: /Users/conrard/Downloads/torchdisorder_v5/data/xrd_measurements/Li3PS4/S_of_Q.csv
    T(r) path: None

  Loaded Data:
    ✓ F(Q)/S(Q) data:
        Bins: 7725
        Q range: [0.46, 17.34] Å⁻¹
        F range: [-0.211, 1.931]
    ✗ T(r) data: Not loaded
======================================================================

Plotting experimental spectrum...

======================================================================
  STRUCTURE GENERATION
======================================================================
  Initialization type: from_cif

  Generated Structure:
    Total atoms: 5054
    Composition: {'P': 1200, 'S': 3854}
    Cell vectors:
      a = 28.9957 Å, b = 94.6618 Å, c = 59.3757 Å
      α = 107.48°, β = 103.55°, γ = 101.86°
    Volume: 144270.79 Å³
    Density: 1.8500 g/cm³

  ⚠ WARNING: NON-CUBIC cell detected
    The cell is NOT cubic. Ensure your model handles this correctly.
======================================================================


======================================================================
  MODEL CONFIGURATION
======================================================================
  Model forward pass: OK
  Available outputs: ['G_r', 'T_r', 'S_Q']
    G_r: shape=torch.Size([1, 1000]), range=[-0.1091, 6.0750]
    T_r: shape=torch.Size([1, 1000]), range=[0.0003, 0.8747]
    S_Q: shape=torch.Size([1, 7725]), range=[-0.9448, 0.9182]
======================================================================

CooperLoss initialized with target: S_Q

======================================================================
  CONSTRAINT CONFIGURATION
======================================================================
  Constraints enabled: True
  Use types: all
  Constraints file: /Users/conrard/Downloads/torchdisorder_v5/data/json/glass_67Li2S_NoLi_constraints.json
  Original constraints: 521 atoms, types: ['tet', 'cn', 'q2', 'q4']
  Cutoff: 3.5 Å
  After filtering: 521 atoms, types: ['q4', 'q2', 'tet', 'cn']
  Filtered constraints saved: outputs/2026-02-01/18-40-52/plots/filtered_constraints.json
  Penalty rho: 10.0
  ✓ Order parameters: PyTorch backend
Found 0 placeholder points where dF = 1e-7
  Created constraint for cn: 521 atoms
  Created constraint for q2: 215 atoms
  Created constraint for tet: 306 atoms
  Created constraint for q4: 217 atoms

Initialized StructureFactorCMPWithConstraints:
  Constrained atoms: 521
  Order parameters: q4, q2, tet, cn
  Total Cooper constraints: 4
  Constraint warmup: 500 steps
======================================================================


======================================================================
  STARTING OPTIMIZATION
======================================================================
  Max steps: 5000
  Target: S(Q)
  Constraints: ON
  Plot interval: 100
  Checkpoint interval: 200
  Gradient clipping: norm ≤ 1.0
  Position clamping: max 0.1 Å/step
  Constraint warmup: 500 steps
======================================================================

  ✓ Gradient safety hook registered on positions

  CooperLoss forward:
    Input keys: ['G_r', 'T_r', 'S_Q']
    Target type: S_Q
    Available targets: S_Q=True, T_r=False, g_r=False
    S(Q): pred=torch.Size([1, 7725]), target=torch.Size([7725])
/Users/conrard/.venv/torchdisorder-x1pC2K7f-py3.12/lib/python3.12/site-packages/warp/_src/torch.py:280: UserWarning:

The .grad attribute of a Tensor that is not a leaf Tensor is being accessed. Its .grad attribute won't be populated during autograd.backward(). If you indeed want the .grad field to be populated for a non-leaf Tensor, use .retain_grad() on the non-leaf Tensor. If you access the non-leaf Tensor by mistake, make sure you access the leaf Tensor instead. See github.com/pytorch/pytorch/pull/30531 for more information. (Triggered internally at /Users/runner/work/pytorch/pytorch/pytorch/build/aten/src/ATen/core/TensorBody.h:494.)
Initial loss: 391.130981
Step 0: Loss=391.130981 (0.0%), Viol: 0.0000/0.0000 (0)

wandb: WARNING Tried to log to step 0 that is less than the current step 1. Steps must be monotonically increasing, so this data will be ignored. See https://wandb.me/define-metric to log data out of order.
/Users/conrard/.venv/torchdisorder-x1pC2K7f-py3.12/lib/python3.12/site-packages/warp/_src/torch.py:280: UserWarning:

The .grad attribute of a Tensor that is not a leaf Tensor is being accessed. Its .grad attribute won't be populated during autograd.backward(). If you indeed want the .grad field to be populated for a non-leaf Tensor, use .retain_grad() on the non-leaf Tensor. If you access the non-leaf Tensor by mistake, make sure you access the leaf Tensor instead. See github.com/pytorch/pytorch/pull/30531 for more information. (Triggered internally at /Users/runner/work/pytorch/pytorch/pytorch/build/aten/src/ATen/core/TensorBody.h:494.)
Step 1: Loss=391.104492 (0.0%), Viol: 0.0041/0.0375 (1062)
Step 2: Loss=391.077484 (0.0%), Viol: 0.0081/0.0750 (1063)
Step 3: Loss=391.050842 (0.0%), Viol: 0.0122/0.1125 (1063)
Step 4: Loss=391.024475 (0.0%), Viol: 0.0163/0.1500 (1062)
Step 5: Loss=390.998047 (0.0%), Viol: 0.0204/0.1875 (1063)
Step 6: Loss=390.971710 (0.0%), Viol: 0.0245/0.2250 (1063)
Step 7: Loss=390.945496 (0.0%), Viol: 0.0287/0.2625 (1063)
Step 8: Loss=390.919495 (0.1%), Viol: 0.0328/0.3000 (1062)
Step 9: Loss=390.893097 (0.1%), Viol: 0.0370/0.3375 (1066)
